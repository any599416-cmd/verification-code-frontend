<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>验证码同步工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        main: '#2563eb',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .code-shake {
                animation: shake 0.5s;
            }
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                20%, 60% { transform: translateX(-5px); }
                40%, 80% { transform: translateX(5px); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-md mx-auto p-4 md:p-6 pt-12">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
                <i class="fa fa-key text-main mr-2"></i>验证码同步
            </h1>

            <!-- 验证码显示区 -->
            <div class="mb-8">
                <div class="text-center text-gray-500 text-sm mb-2">最新验证码</div>
                <div id="code-display" class="text-4xl font-bold text-center py-4 px-2 bg-gray-50 rounded-lg border border-gray-200 min-h-[80px] flex items-center justify-center">
                    -- -- -- --
                </div>
                <div class="text-right text-gray-400 text-xs mt-2" id="update-time">
                    最后更新：无数据
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="refresh-btn" class="bg-main hover:bg-main/90 text-white py-3 px-4 rounded-lg transition flex items-center justify-center">
                    <i class="fa fa-refresh mr-2"></i> 刷新
                </button>
                <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg transition flex items-center justify-center">
                    <i class="fa fa-trash mr-2"></i> 清空
                </button>
            </div>

            <!-- 手动输入验证码（用于测试） -->
            <div class="border-t border-gray-100 pt-6">
                <div class="text-sm text-gray-500 mb-3">手动输入验证码（测试用）</div>
                <div class="flex gap-2">
                    <input type="text" id="manual-code" placeholder="例如：1234" 
                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-main/50">
                    <button id="send-manual-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 rounded-lg transition">
                        发送
                    </button>
                </div>
            </div>

            <!-- 状态提示 -->
            <div id="status" class="mt-4 text-sm text-center py-2 rounded-lg bg-blue-50 text-blue-700">
                请确保手机和电脑在同一网络
            </div>
        </div>

        <div class="text-center text-gray-400 text-xs mt-6">
            每5秒自动刷新一次
        </div>
    </div>

    <script>
        // ！！！替换成你电脑的局域网IP（例如：192.168.1.105）
        const API_URL = 'http://192.168.0.175:5000'; 

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定按钮事件
            document.getElementById('refresh-btn').addEventListener('click', getCode);
            document.getElementById('clear-btn').addEventListener('click', clearCode);
            document.getElementById('send-manual-btn').addEventListener('click', sendManualCode);
            
            // 初始加载
            getCode();
            // 自动刷新（5秒一次）
            setInterval(getCode, 5000);
        });

        // 获取验证码
        async function getCode() {
            try {
                const response = await fetch(`${API_URL}/get-latest-code`);
                if (!response.ok) throw new Error('网络错误');
                
                const data = await response.json();
                const codeDisplay = document.getElementById('code-display');
                
                // 更新显示
                if (data.code) {
                    codeDisplay.textContent = data.code;
                    codeDisplay.classList.add('code-shake');
                    setTimeout(() => codeDisplay.classList.remove('code-shake'), 500);
                } else {
                    codeDisplay.textContent = '-- -- -- --';
                }
                document.getElementById('update-time').textContent = `最后更新：${data.update_time || '无数据'}`;
                updateStatus('正常', 'success');
            } catch (error) {
                updateStatus(`获取失败：${error.message}`, 'error');
                console.error('获取失败：', error);
            }
        }

        // 清空验证码
        async function clearCode() {
            try {
                await fetch(`${API_URL}/clear-code`, { method: 'POST' });
                getCode(); // 立即刷新
                updateStatus('已清空', 'info');
            } catch (error) {
                updateStatus(`清空失败：${error.message}`, 'error');
            }
        }

        // 手动发送验证码（测试用）
        async function sendManualCode() {
            const code = document.getElementById('manual-code').value.trim();
            if (!code) {
                updateStatus('请输入验证码', 'warning');
                return;
            }

            try {
                await fetch(`${API_URL}/receive-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                document.getElementById('manual-code').value = '';
                getCode(); // 立即刷新
                updateStatus('发送成功', 'success');
            } catch (error) {
                updateStatus(`发送失败：${error.message}`, 'error');
            }
        }

        // 更新状态提示
        function updateStatus(text, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            
            // 重置样式
            statusEl.className = 'mt-4 text-sm text-center py-2 rounded-lg';
            
            // 设置样式
            switch(type) {
                case 'success':
                    statusEl.classList.add('bg-green-50', 'text-green-700');
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-50', 'text-red-700');
                    break;
                case 'warning':
                    statusEl.classList.add('bg-yellow-50', 'text-yellow-700');
                    break;
                default:
                    statusEl.classList.add('bg-blue-50', 'text-blue-700');
            }
        }
    </script>
</body>
</html>